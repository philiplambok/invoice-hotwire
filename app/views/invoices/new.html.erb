<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h5>Create a new invoice</h5>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <%= form_with(model: @invoice, data: { controller: 'invoices' }) do |form| %>
        <div class="form-group">
          <%= form.label :number, class: 'form-label' %>
          <%= form.text_field :number, placeholder: 'Invoice Number', class: 'form-control', required: true %>
        </div>
        <div class="form-group mt-2 row">
          <div class="col-md-6">
            <%= form.label :customer, class: 'form-label' %>
            <%= form.select :customer, 
                Customer.all.pluck(:name, :email), 
                { prompt: 'Select Customer' }, 
                { required: true, class: 'form-control', data: { action: 'change->invoices#updateEmail' } } %>
          </div>
          <div class="col-md-6">
            <%= form.label :email, class: 'form-label' %>
            <%= form.text_field :email, class: 'form-control', disabled: true, class: 'form-control', data: { 'invoices-target': 'emailField' }  %>
          </div>
        </div>

        <span class="fw-bold d-block my-4">Products</span>

        <%= fields_for('invoice_products[]', InvoiceProduct.new) do |product_form| %>
          <div class="form-group row" data-controller="invoice-products">
            <div class="col-md-4">
              <%= product_form.label :product_name, class: 'form-label' %>
              <%= product_form.select :product_id, 
                                      options_for_select(products_options), 
                                      { prompt: 'Select product' }, 
                                      class: 'form-control', 
                                      data: { 'invoice-products-target': 'productItem', action: 'change->invoice-products#clearPrices' }%>
            </div>
            <div class="col-md-2">
              <%= product_form.label :unit, class: 'form-label' %>
              <%= product_form.number_field :unit, class: 'form-control', data: { action: 'change->invoice-products#updateProductItemPrice', 'invoice-products-target': 'unit' } %>
            </div>
            <div class="col-md-2">
              <%= product_form.label :price_per_unit, class: 'form-label' %>
              <%= product_form.text_field :price_per_unit, class: 'form-control', disabled: true, data: { 'invoice-products-target': 'pricePerUnit' } %>
            </div>
            <div class="col-md-4">
              <%= product_form.label :total, class: 'form-label' %>
              <%= product_form.text_field :total, class: 'form-control', disabled: true, data: { 'invoice-products-target': 'total', action: 'change->invoices#updateTotal' } %>
            </div>
          </div>
        <% end %>

        <%= fields_for('invoice_products[]', InvoiceProduct.new) do |product_form| %>
          <div class="form-group row" data-controller="invoice-products">
            <div class="col-md-4">
              <%= product_form.label :product_name, class: 'form-label' %>
              <%= product_form.select :product_id, 
                                      options_for_select(products_options), 
                                      { prompt: 'Select product' }, 
                                      class: 'form-control', 
                                      data: { 'invoice-products-target': 'productItem', action: 'change->invoice-products#clearPrices' }%>
            </div>
            <div class="col-md-2">
              <%= product_form.label :unit, class: 'form-label' %>
              <%= product_form.number_field :unit, class: 'form-control', data: { action: 'change->invoice-products#updateProductItemPrice', 'invoice-products-target': 'unit' } %>
            </div>
            <div class="col-md-2">
              <%= product_form.label :price_per_unit, class: 'form-label' %>
              <%= product_form.text_field :price_per_unit, class: 'form-control', disabled: true, data: { 'invoice-products-target': 'pricePerUnit' } %>
            </div>
            <div class="col-md-4">
              <%= product_form.label :total, class: 'form-label' %>
              <%= product_form.text_field :total, class: 'form-control', disabled: true, data: { 'invoice-products-target': 'total', action: 'change->invoices#updateTotal' } %>
            </div>
          </div>
        <% end %>
        <hr>
        <div class="row d-flex align-items-center">
          <div class="col">
            <span class="d-block">Total</span>
            <span class="fw-bold" data-invoices-target="total">Rp 0</span>
          </div>
          <div class="col d-flex flex-row-reverse">
            <%= form.submit 'Submit', class: 'btn btn-primary px-4' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>